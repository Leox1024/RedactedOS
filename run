#!/bin/sh

if [ -z "$BASH_VERSION" ]; then
    if command -v bash >/dev/null 2>&1; then
        exec bash "$0" "$@"
    else
        exec sh "$0" "$@"
    fi
fi

echo "Running emulator"

ARGS=""
if [ "$1" = "debug" ]; then
  ARGS="-monitor unix:/tmp/qemu-monitor-socket,server,nowait -s -S"
fi

MSI_CAPABILITIES=""

XHCI_CAPABILITIES="$(qemu-system-aarch64 -device qemu-xhci,help)"

if echo "$XHCI_CAPABILITIES" | grep -q "msi "; then
  MSI_CAPABILITIES="msi=on,msix=off,"
fi

OS_TYPE="$(uname)"

if [[ "$OS_TYPE" == "Darwin" ]]; then
    NETARG="vmnet-bridged,id=net0,ifname=en0"

elif [[ "$OS_TYPE" == "Linux" ]]; then
    NETARG="user,id=net0"

else
    echo "Unknown OS: $OS_TYPE" >&2
    exit 1
fi


qemu-system-aarch64 \
  -M virt \
  -cpu cortex-a72 \
  -m 512M \
  -kernel kernel.elf \
  -device virtio-gpu-pci \
  -display sdl \
  -netdev ${NETARG} \
  -device virtio-net-pci,netdev=net0 \
  -serial mon:stdio \
  -drive file=disk.img,if=none,format=raw,id=hd0 \
  -device virtio-blk-pci,drive=hd0 \
  -device qemu-xhci,${MSI_CAPABILITIES}id=usb \
  -device usb-kbd,bus=usb.0 \
  -d guest_errors \
  $ARGS
